<!--
    NOTE: Will be imported into index.html by gulp-html-import

    @file scripts.html
    @description <script> elements inside the <body> of index.html
    @author Jared Dantis (@aureljared)
    @license GPLv2
-->

<!-- JS libraries -->
<script defer type="text/javascript" src="dist/js/jquery.min.js" id="scJq"></script>
<script async defer type="text/javascript" src="dist/js/fastclick.min.js" id="scFc"></script>

<!-- Main page scripts -->
<script defer type="text/javascript" src="dist/js/script.js" id="scGw"></script>
<script type="text/javascript">
    // WebFontLoader config
    WebFontConfig = {
        google: {
            families: [
                'Roboto:400,500',
                'Roboto Mono:400,700'
            ]
        }
    };

    window.onload = function(){
        // Initialize app
        app.init();

        // Load webfonts
        (function(d) {
            var wf = document.createElement('script'),
                s = d.scripts[0];
            wf.src = 'dist/js/webfontloader.min.js';
            wf.async = true;
            s.parentNode.insertBefore(wf, s);
        })(document);

        // Add to home screen banner (Chrome)
        window.addEventListener('beforeinstallprompt', function(e) {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Show prompt
            e.prompt();
            // Wait for user input
            e.userChoice.then(function(choice) {
                if (choice.outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                } else {
                    console.log('User dismissed the A2HS prompt');
                }
                e = null;
            });
        });
    };

    // On jQuery load
    tsLoaded = false;
    scJq.addEventListener('load', function(){
        // Detection from https://stackoverflow.com/a/9039885/3350320
        var iOS = !!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform);
        if (iOS) {
            // Remove download button if on iOS
            $('#btn-android').parent().remove();

            // Check for PWA support (iOS 11.3+)
            if ('standalone' in window.navigator && window.navigator.standalone) {
                // TODO: display install popup
            }
        } else {
            // Update APK download link
            var baseUri = 'https://api.github.com/repos/illustra/gwa-android/releases/latest';
            $.getJSON(baseUri, function(data){
                var apkUri = data.assets[0].browser_download_url;
                $('#btn-android').parent().attr('href', apkUri);
            });
        }

        // Load touchSwipe
        (function(d) {
            var ts = document.createElement('script'),
                s = d.scripts[0];
            ts.src = 'dist/js/touchswipe.min.js';
            ts.async = true;
            ts.onload = ts.onreadystatechange = function() {
                if (!tsLoaded && (!this.readyState ||
                    this.readyState === "loaded" || this.readyState === "complete")) {
                    // On touchSwipe load
                    tsLoaded = true;
                    $('body').swipe({
                        swipe: function(s,w,i,p,e,r){
                            switch (w) {
                                case "right":
                                    $('#menu').addClass('visible');
                                    $('#menu-bg').fadeIn();
                                    break;
                                case "left":
                                    $('#menu').removeClass('visible');
                                    $('#menu-bg').fadeOut();
                            }
                        }
                    });
                }
            };
            s.parentNode.insertBefore(ts, s);
        })(document);
    });

    // on FastClick load
    scFc.addEventListener('load', function(){
        // Init FastClick
        FastClick.attach(document.body);
    });

    // Service worker with update functionality
    // https://medium.com/progressive-web-apps/pwa-create-a-new-update-available-notification-using-service-workers-18be9168d717
    window.isUpdateAvailable = new Promise(function(resolve, reject) {
        if ('serviceWorker' in navigator) {
            // Register service worker
            navigator.serviceWorker.register('sw.js')
                .then(function(reg) {
                    console.log("[sw] Registered with scope " + reg.scope);

                    reg.onupdatefound = function() {
                        var instWkr = reg.installing;
                        instWkr.onstatechange = function() {
                            if (instWkr.state == "installed") {
                                if (navigator.serviceWorker.controller) {
                                    // new update available
                                    resolve(true);
                                } else {
                                    // no update available
                                    resolve(false);
                                }
                            }
                        };
                    };
                })
                .catch(function(error) {
                    console.error("[sw] Error while registering: " + error);
                });
        }
    });
</script>
