<!--
    NOTE: Will be imported into index.html by gulp-html-import

    @file scripts.html
    @description <script> elements inside the <body> of index.html
    @author Jared Dantis (@jareddantis)
    @license GPLv2
-->

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/6.0.2/firebase-app.js"></script>
<script>
    var firebaseConfig = {
        apiKey: "AIzaSyBvz9rV3292l0G64j1fZN3WhXRf1P-eMmE",
        authDomain: "gwa-calc.firebaseapp.com",
        databaseURL: "https://gwa-calc.firebaseio.com",
        projectId: "gwa-calc",
        storageBucket: "gwa-calc.appspot.com",
        messagingSenderId: "529570912429",
        appId: "1:529570912429:web:a962817fb6bd3484"
    };
    firebase.initializeApp(firebaseConfig);
</script>

<!-- JS libraries -->
<script defer type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" id="scJq"></script>
<script async defer type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js" id="scFc"></script>
<script async defer type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js" id="scSc"></script>
<script async defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/vanilla-ripplejs@1.0.6" id="scRp"></script>

<!-- Main page scripts -->
<script defer type="text/javascript" src="dist/js/script.js" id="scGw"></script>
<script type="text/javascript">
    // WebFontLoader config
    WebFontConfig = {
        google: {
            families: [
                'Roboto Mono:400,700'
            ]
        }
    };

    window.onload = function(){
        // Initialize app
        app.init();

        // Load webfonts
        (function(d) {
            var wf = document.createElement('script'),
                s = d.scripts[0];
            wf.src = 'https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js';
            wf.async = true;
            s.parentNode.insertBefore(wf, s);
        })(document);

        // Add to home screen banner (Chrome)
        window.addEventListener('beforeinstallprompt', function(e) {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Show prompt
            e.prompt();
            // Wait for user input
            e.userChoice.then(function(choice) {
                if (choice.outcome === 'accepted') {
                    console.log('[window] User accepted the A2HS prompt');
                } else {
                    console.log('[window] User dismissed the A2HS prompt');
                }
                e = null;
            });
        });
    };

    // On jQuery load
    let tsLoaded = false;
    scJq.addEventListener('load', function(){
        // iOS-specific logic
        // Detection from https://stackoverflow.com/a/9039885/3350320
        var iOS = !!navigator.platform && /iPad|iPhone|iPod/.test(navigator.platform);
        if (iOS) {
            // Check for PWA support (iOS 11.3+)
            if ('standalone' in window.navigator && window.navigator.standalone) {
                // TODO: display install popup
            }
        }

        // Load touchSwipe
        (function(d) {
            var ts = document.createElement('script'),
                s = d.scripts[0];
            ts.src = 'https://cdnjs.cloudflare.com/ajax/libs/jquery.touchswipe/1.6.18/jquery.touchSwipe.min.js';
            ts.async = true;
            s.parentNode.insertBefore(ts, s);
        })(document);
    });

    // on FastClick load
    scFc.addEventListener('load', function(){
        // Init FastClick
        FastClick.attach(document.body);
    });

    // Service worker with update functionality
    // https://medium.com/progressive-web-apps/pwa-create-a-new-update-available-notification-using-service-workers-18be9168d717
    window.isUpdateAvailable = new Promise(function(resolve, reject) {
        if ('serviceWorker' in navigator) {
            // Register service worker
            navigator.serviceWorker.register('sw.js')
                .then(function(reg) {
                    console.log("[sw] Registered with scope " + reg.scope);

                    reg.addEventListener('updatefound', function() {
                        var instWkr = reg.installing;

                        instWkr.addEventListener('statechange', function() {
                            if (instWkr.state === "installed") {
                                if (navigator.serviceWorker.controller) {
                                    // new update available
                                    resolve(true);
                                } else {
                                    // no update available
                                    resolve(false);
                                }
                            }
                        });
                    });
                })
                .catch(function(error) {
                    console.error("[sw] Error while registering: " + error);
                });
        }
    });
</script>
